(module score racket
  
  (provide (except-out (all-defined-out) root))
  
  (require "node.rkt")
  (require racket/pretty)
  
  (define root
    (node i_b #t 0 '("wk" "wq" "bk" "bq") (cons 0 0) 0))
  
  (define mat
    (hash
     #\K 20000 #\Q 900
     #\R 500 #\B 330
     #\N 320 #\P 100
     #\k -20000 #\q -900
     #\r -500 #\b -330
     #\n -320 #\p -100))
  
  (define (neg p)
    (map
     (lambda (x)
       (* -1
          (list-ref p
                    (+ (- 110 (* (quotient x 10) 10)) (remainder x 10)))))
     (for/list ([x (in-range 0 120)]) x)))
  
  (define pst
    (hash
     #\P
     '(0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0 50 50 50 50 50 50 50 50  0
          0 10 10 20 30 30 20 10 10  0
          0  5  5 10 25 25 10  5  5  0
          0  0  0  0 20 20  0  0  0  0
          0  5 -5 -10  0  0 -10 -5  5  0
          0  5 10 10 -20 -20 10 10  5  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0)
     
     
     #\N
     '(  0  0  0  0  0  0  0  0  0  0
            0  0  0  0  0  0  0  0  0  0
            0 -50 -40 -30 -30 -30 -30 -40 -50  0
            0 -40 -20  0  0  0  0 -20 -40  0
            0 -30  0 10 15 15 10  0 -30  0
            0 -30  5 15 20 20 15  5 -30  0
            0 -30  0 15 20 20 15  0 -30  0
            0 -30  5 10 15 15 10  5 -30  0
            0 -40 -20  0  5  5  0 -20 -40  0
            0 -50 -40 -30 -30 -30 -30 -40 -50  0
            0  0  0  0  0  0  0  0  0  0
            0  0  0  0  0  0  0  0  0  0)
     #\B
     '(0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0 -20 -10 -10 -10 -10 -10 -10 -20  0
          0 -10  0  0  0  0  0  0 -10  0
          0 -10  0  5 10 10  5  0 -10  0
          0 -10  5  5 10 10  5  5 -10  0
          0 -10  0 10 10 10 10  0 -10  0
          0 -10 10 10 10 10 10 10 -10  0
          0 -10  5  0  0  0  0  5 -10  0
          0 -20 -10 -10 -10 -10 -10 -10 -20  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0)
     #\R
     '(0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0  5 10 10 10 10 10 10  5  0
          0 -5  0  0  0  0  0  0 -5  0
          0 -5  0  0  0  0  0  0 -5  0
          0 -5  0  0  0  0  0  0 -5  0
          0 -5  0  0  0  0  0  0 -5  0
          0 -5  0  0  0  0  0  0 -5  0
          0  0  0  0  5  5  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0)
     #\Q
     '(0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0 -20 -10 -10 -5 -5 -10 -10 -20  0
          0 -10  0  0  0  0  0  0 -10  0
          0 -10  0  5  5  5  5  0 -10  0
          0 -5  0  5  5  5  5  0 -5  0
          0  0  0  5  5  5  5  0 -5  0
          0 -10  5  5  5  5  5  0 -10  0
          0 -10  0  5  0  0  0  0 -10  0
          0 -20 -10 -10 -5 -5 -10 -10 -20  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0)
     #\K
     '(0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0
          0 -30 -40 -40 -50 -50 -40 -40 -30  0
          0 -30 -40 -40 -50 -50 -40 -40 -30  0
          0 -30 -40 -40 -50 -50 -40 -40 -30  0
          0 -30 -40 -40 -50 -50 -40 -40 -30  0
          0 -20 -30 -30 -40 -40 -30 -30 -20  0
          0 -10 -20 -20 -20 -20 -20 -20 -10  0
          0 20 20  0  0  0  0 20 20  0
          0 20 30 10  0  0 10 30 20  0
          0  0  0  0  0  0  0  0  0  0
          0  0  0  0  0  0  0  0  0  0)))
  
  (define pstt
    (hash-set* pst
               #\p (neg (hash-ref pst #\P))
               #\n (neg (hash-ref pst #\N))
               #\b (neg (hash-ref pst #\B))
               #\r (neg (hash-ref pst #\R))
               #\q (neg (hash-ref pst #\Q))
               #\k (neg (hash-ref pst #\K))))
  
  
  (define (score n)
    (for/sum ([y 
               (map 
                (lambda (x)
                  (if (hash-has-key? mat (string-ref (node-b n) x))
                      (+
                       (hash-ref mat (string-ref (node-b n) x))
                       (list-ref (hash-ref pstt (string-ref (node-b n) x)) x)
                       ) 0)) 
                (for/list ([x (in-range 0 120)]) x))]) y)
    )
  
  )
